# ğŸ“ çŸ¥è¯†è’¸é¦æ•°å­¦åŸç†è¯¦è§£

**é¢è¯•å‡†å¤‡ï¼šæ·±å…¥ç†è§£æ•°å­¦å…¬å¼èƒŒåçš„åŸç†**

---

## 1. æ ¸å¿ƒæŸå¤±å‡½æ•°ï¼šä»ç›´è§‰åˆ°å…¬å¼

### 1.1 æŸå¤±å‡½æ•°çš„å®Œæ•´å½¢å¼

$$L_{total} = \alpha \cdot L_{CE}(student, labels) + (1-\alpha) \cdot T^2 \cdot L_{KL}(soft_{student}, soft_{teacher})$$

### 1.2 é€é¡¹è§£é‡Š

#### ç¬¬ä¸€é¡¹ï¼šäº¤å‰ç†µæŸå¤± $L_{CE}$

**å…¬å¼**ï¼š
$$L_{CE} = -\sum_{i=1}^{C} y_i \log(p_i)$$

**é€šä¿—ç†è§£**ï¼š
- $y_i$ï¼šçœŸå®æ ‡ç­¾ï¼ˆone-hotï¼Œåªæœ‰æ­£ç¡®ç­”æ¡ˆæ˜¯1ï¼Œå…¶ä»–æ˜¯0ï¼‰
- $p_i$ï¼šStudent æ¨¡å‹é¢„æµ‹çš„ç¬¬ $i$ ç±»çš„æ¦‚ç‡
- **ä½œç”¨**ï¼šè®© Student å­¦ä¼š"æ­£ç¡®ç­”æ¡ˆæ˜¯ä»€ä¹ˆ"

**ä¾‹å­**ï¼š
- çœŸå®æ ‡ç­¾ï¼šçŒ«ï¼ˆç¬¬4ç±»ï¼‰â†’ $y = [0, 0, 0, 1, 0, 0, 0, 0, 0, 0]$
- Student é¢„æµ‹ï¼š$p = [0.1, 0.05, 0.1, 0.6, 0.05, 0.05, 0.02, 0.01, 0.01, 0.01]$
- æŸå¤± = $-1 \times \log(0.6) = 0.51$ï¼ˆè¶Šå°è¶Šå¥½ï¼‰

---

#### ç¬¬äºŒé¡¹ï¼šKL æ•£åº¦æŸå¤± $L_{KL}$

**å…¬å¼**ï¼š
$$L_{KL} = D_{KL}(P_{teacher} \| Q_{student}) = \sum_{i=1}^{C} P_i \log \frac{P_i}{Q_i}$$

å…¶ä¸­ï¼š
- $P_i = \text{softmax}(z_{teacher} / T)$ï¼šTeacher çš„è½¯æ ‡ç­¾
- $Q_i = \text{softmax}(z_{student} / T)$ï¼šStudent çš„è½¯æ ‡ç­¾

**é€šä¿—ç†è§£**ï¼š
- **KL æ•£åº¦è¡¡é‡ä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒçš„å·®å¼‚**
- å¦‚æœ Teacher è®¤ä¸º"çŒ«çš„æ¦‚ç‡æ˜¯ 0.6ï¼Œç‹—çš„æ¦‚ç‡æ˜¯ 0.15"
- Student ä¹Ÿåº”è¯¥è®¤ä¸º"çŒ«çš„æ¦‚ç‡æ˜¯ 0.6ï¼Œç‹—çš„æ¦‚ç‡æ˜¯ 0.15"
- **ä½œç”¨**ï¼šè®© Student æ¨¡ä»¿ Teacher çš„"æ€è€ƒæ–¹å¼"

**ä¸ºä»€ä¹ˆç”¨ Forward KLï¼Ÿ**
$$D_{KL}(P \| Q) = \sum P_i \log \frac{P_i}{Q_i}$$

- å½“ $P_i > 0$ ä½† $Q_i \to 0$ æ—¶ï¼ŒæŸå¤±ä¼š**çˆ†ç‚¸**ï¼ˆ$\log \frac{P_i}{0} \to \infty$ï¼‰
- è¿™è¿«ä½¿ Student **å¿…é¡»è¦†ç›–** Teacher è®¤ä¸ºå¯èƒ½çš„æ‰€æœ‰ç±»åˆ«
- æˆ‘ä»¬æƒ³è¦ Student å­¦ä¹  Teacher çš„**å…¨éƒ¨çŸ¥è¯†**ï¼Œæ‰€ä»¥ç”¨ Forward KL

---

## 2. Softmax å’Œ Temperatureï¼šä»å°–é”åˆ°å¹³æ»‘

### 2.1 æ ‡å‡† Softmax

**å…¬å¼**ï¼š
$$\text{softmax}(z_i) = \frac{e^{z_i}}{\sum_{j=1}^{C} e^{z_j}}$$

**ä¾‹å­**ï¼ˆå‡è®¾ logits = [2, 1, 0.5]ï¼‰ï¼š
- æ ‡å‡† softmax: [0.66, 0.24, 0.10] â†’ **å¾ˆå°–é”ï¼Œå‡ ä¹ one-hot**

### 2.2 å¸¦ Temperature çš„ Softmax

**å…¬å¼**ï¼š
$$\text{softmax}(z_i / T) = \frac{e^{z_i/T}}{\sum_{j=1}^{C} e^{z_j/T}}$$

**ç›´è§‚ç†è§£**ï¼š
- **T=1**ï¼šæ ‡å‡† softmaxï¼Œåˆ†å¸ƒå°–é”
- **T>1**ï¼šåˆ†å¸ƒå˜å¹³æ»‘ï¼Œå°æ¦‚ç‡å€¼è¢«"æ”¾å¤§"
- **Tâ†’âˆ**ï¼šæ¥è¿‘å‡åŒ€åˆ†å¸ƒ [1/3, 1/3, 1/3]

**ä¾‹å­**ï¼ˆlogits = [2, 1, 0.5]ï¼‰ï¼š

| T | ç»“æœ | è§£é‡Š |
|---|------|------|
| T=1 | [0.66, 0.24, 0.10] | å°–é”ï¼Œå‡ ä¹ one-hot |
| T=4 | [0.45, 0.32, 0.23] | å¹³æ»‘ï¼Œæš´éœ²ç›¸ä¼¼æ€§ |
| T=10 | [0.38, 0.33, 0.29] | æ›´å¹³æ»‘ï¼Œæ¥è¿‘å‡åŒ€ |

**ä¸ºä»€ä¹ˆéœ€è¦ Temperatureï¼Ÿ**
- **ç¡¬æ ‡ç­¾**åªå‘Šè¯‰æˆ‘ä»¬"è¿™æ˜¯çŒ«"ï¼ˆone-hotï¼‰
- **è½¯æ ‡ç­¾**å‘Šè¯‰æˆ‘ä»¬"è¿™æ˜¯çŒ«ï¼Œä½†æœ‰ç‚¹åƒç‹—"ï¼ˆæ¦‚ç‡åˆ†å¸ƒï¼‰
- Temperature è¶Šå¤§ï¼Œè½¯æ ‡ç­¾è¶Š"è½¯"ï¼ŒåŒ…å«çš„**ç±»é—´ç›¸ä¼¼æ€§ä¿¡æ¯**è¶Šå¤š

---

## 3. ä¸ºä»€ä¹ˆè¦ä¹˜ä»¥ TÂ²ï¼Ÿæ•°å­¦æ¨å¯¼

### 3.1 é—®é¢˜ï¼šæ¢¯åº¦ç¼©æ”¾

å½“æˆ‘ä»¬è®¡ç®—ï¼š
$$L_{KL} = \sum P_i \log \frac{P_i}{Q_i}$$

å…¶ä¸­ $Q_i = \text{softmax}(z_i / T)$

### 3.2 æ¢¯åº¦åˆ†æ

**Student logits çš„æ¢¯åº¦**ï¼š
$$\frac{\partial L_{KL}}{\partial z_i} = \frac{1}{T} \cdot (Q_i - P_i)$$

**å…³é”®å‘ç°**ï¼š
- æ¢¯åº¦è¢« **é™¤ä»¥äº† T**ï¼ˆå› ä¸ºæˆ‘ä»¬åœ¨ softmax é‡Œé™¤ä»¥äº† Tï¼‰
- å¦‚æœ T=4ï¼Œæ¢¯åº¦ä¼šç¼©å° **4 å€**
- å¦‚æœ T=16ï¼Œæ¢¯åº¦ä¼šç¼©å° **16 å€**

### 3.3 ä¸ºä»€ä¹ˆä¹˜ä»¥ TÂ²ï¼Ÿ

**å®Œæ•´æ¢¯åº¦**ï¼ˆè€ƒè™‘ TÂ² ç¼©æ”¾ï¼‰ï¼š
$$\frac{\partial (T^2 \cdot L_{KL})}{\partial z_i} = T^2 \cdot \frac{1}{T} \cdot (Q_i - P_i) = T \cdot (Q_i - P_i)$$

**æ›´ç²¾ç¡®çš„åˆ†æ**ï¼š
- Softmax çš„æ¢¯åº¦æœ¬èº«ä¼šç¼©å°çº¦ $1/T^2$ï¼ˆå› ä¸ºé™¤ä»¥ T ä¸¤æ¬¡ï¼šä¸€æ¬¡åœ¨æŒ‡æ•°ï¼Œä¸€æ¬¡åœ¨å½’ä¸€åŒ–ï¼‰
- æ‰€ä»¥éœ€è¦ä¹˜ä»¥ $T^2$ æ¥**è¡¥å¿**ï¼Œä¿æŒæ¢¯åº¦é‡çº§ä¸€è‡´

**å®é™…æ•ˆæœ**ï¼š
- ä¸åŒ T å€¼ä¸‹ï¼Œæ¢¯åº¦é‡çº§ä¿æŒåœ¨åŒä¸€æ°´å¹³
- è®­ç»ƒæ›´ç¨³å®šï¼Œä¸ä¼šå› ä¸º T å¤ªå¤§è€Œå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±

---

## 4. KL æ•£åº¦çš„ä¸¤ç§å½¢å¼ï¼šForward vs Reverse

### 4.1 Forward KLï¼ˆæˆ‘ä»¬ç”¨çš„ï¼‰

$$D_{KL}(P \| Q) = \sum_{i} P_i \log \frac{P_i}{Q_i}$$

**ç‰¹ç‚¹**ï¼š
- å½“ $P_i > 0$ ä½† $Q_i \to 0$ æ—¶ï¼ŒæŸå¤±**çˆ†ç‚¸**ï¼ˆ$\log \frac{P_i}{0} \to \infty$ï¼‰
- è¿«ä½¿ $Q$ **å¿…é¡»è¦†ç›–** $P$ çš„æ‰€æœ‰éé›¶åŒºåŸŸ

**ä¾‹å­**ï¼š
- Teacher: [0.6, 0.3, 0.1, 0, 0, ...]
- Student: [0.9, 0.1, 0, 0, 0, ...] â†’ **æŸå¤±å¾ˆå¤§**ï¼ˆå› ä¸º Teacher è®¤ä¸ºç¬¬3ç±»æœ‰ 0.1 æ¦‚ç‡ï¼Œä½† Student è®¤ä¸ºæ˜¯ 0ï¼‰

**ä¸ºä»€ä¹ˆç”¨ Forward KLï¼Ÿ**
- æˆ‘ä»¬å¸Œæœ› Student å­¦ä¹  Teacher çš„**å…¨éƒ¨çŸ¥è¯†**
- åŒ…æ‹¬ Teacher è®¤ä¸º"å¯èƒ½ä½†ä¸ç¡®å®š"çš„ç±»åˆ«
- Forward KL ç¡®ä¿ Student ä¸ä¼šå¿½ç•¥è¿™äº›ä¿¡æ¯

---

### 4.2 Reverse KLï¼ˆæˆ‘ä»¬ä¸ç”¨çš„ï¼‰

$$D_{KL}(Q \| P) = \sum_{i} Q_i \log \frac{Q_i}{P_i}$$

**ç‰¹ç‚¹**ï¼š
- å½“ $Q_i > 0$ ä½† $P_i \to 0$ æ—¶ï¼ŒæŸå¤±**çˆ†ç‚¸**
- è¿«ä½¿ $Q$ **åªå…³æ³¨** $P$ çš„éé›¶åŒºåŸŸï¼Œå¿½ç•¥å…¶ä»–

**ä¾‹å­**ï¼š
- Teacher: [0.6, 0.3, 0.1, 0, 0, ...]
- Student: [0.6, 0.3, 0.1, 0, 0, ...] â†’ **æŸå¤±å¾ˆå°**
- Student: [0.6, 0.3, 0.1, 0.01, 0, ...] â†’ **æŸå¤±å¾ˆå¤§**ï¼ˆå› ä¸º Student è®¤ä¸ºç¬¬4ç±»æœ‰æ¦‚ç‡ï¼Œä½† Teacher è®¤ä¸ºæ˜¯ 0ï¼‰

**ä¸ºä»€ä¹ˆä¸ç”¨ Reverse KLï¼Ÿ**
- Reverse KL ä¼šè®© Student **è¿‡åº¦è‡ªä¿¡**
- åªæŠ“ä½ä¸€ä¸ªæ¨¡å¼ï¼Œå¿½ç•¥å…¶ä»–å¯èƒ½æ€§
- ä¸é€‚åˆçŸ¥è¯†è’¸é¦ï¼ˆæˆ‘ä»¬æƒ³è¦ Student å­¦ä¹ å…¨éƒ¨çŸ¥è¯†ï¼‰

---

## 5. äº¤å‰ç†µ vs KL æ•£åº¦çš„å…³ç³»

### 5.1 æ•°å­¦å…³ç³»

**äº¤å‰ç†µ**ï¼š
$$H(P, Q) = -\sum P_i \log Q_i$$

**KL æ•£åº¦**ï¼š
$$D_{KL}(P \| Q) = \sum P_i \log \frac{P_i}{Q_i} = \sum P_i \log P_i - \sum P_i \log Q_i$$

**å…³ç³»**ï¼š
$$D_{KL}(P \| Q) = H(P, Q) - H(P)$$

å…¶ä¸­ $H(P) = -\sum P_i \log P_i$ æ˜¯ $P$ çš„ç†µï¼ˆå›ºå®šå€¼ï¼‰

**ç»“è®º**ï¼š
- å½“ $P$ å›ºå®šæ—¶ï¼ˆTeacher çš„è½¯æ ‡ç­¾ï¼‰ï¼Œæœ€å°åŒ– KL æ•£åº¦ = æœ€å°åŒ–äº¤å‰ç†µ
- è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨ KL æ•£åº¦æ¥"å¯¹é½"ä¸¤ä¸ªåˆ†å¸ƒ

---

## 6. å®Œæ•´è®­ç»ƒæµç¨‹çš„æ•°å­¦è¡¨è¾¾

### 6.1 å‰å‘ä¼ æ’­

1. **è¾“å…¥å›¾åƒ** $x$
2. **Teacher è¾“å‡º**ï¼š$z_t = \text{Teacher}(x)$
3. **Student è¾“å‡º**ï¼š$z_s = \text{Student}(x)$
4. **è½¯æ ‡ç­¾**ï¼š
   - $P_t = \text{softmax}(z_t / T)$
   - $P_s = \text{softmax}(z_s / T)$

### 6.2 æŸå¤±è®¡ç®—

$$L = \alpha \cdot \underbrace{-\sum y_i \log P_{s,i}}_{\text{ç¡¬æ ‡ç­¾æŸå¤±}} + (1-\alpha) \cdot T^2 \cdot \underbrace{\sum P_{t,i} \log \frac{P_{t,i}}{P_{s,i}}}_{\text{è½¯æ ‡ç­¾æŸå¤±}}$$

### 6.3 åå‘ä¼ æ’­

$$\frac{\partial L}{\partial z_{s,i}} = \alpha \cdot \frac{\partial L_{CE}}{\partial z_{s,i}} + (1-\alpha) \cdot T^2 \cdot \frac{\partial L_{KL}}{\partial z_{s,i}}$$

å…¶ä¸­ï¼š
- $\frac{\partial L_{CE}}{\partial z_{s,i}} = P_{s,i} - y_i$ï¼ˆæ ‡å‡†äº¤å‰ç†µæ¢¯åº¦ï¼‰
- $\frac{\partial L_{KL}}{\partial z_{s,i}} = \frac{1}{T} \cdot (P_{s,i} - P_{t,i})$ï¼ˆKL æ•£åº¦æ¢¯åº¦ï¼‰

---

## 7. é¢è¯•å¸¸è§æ•°å­¦é—®é¢˜é€Ÿç­”

### Q: ä¸ºä»€ä¹ˆæŸå¤±å‡½æ•°è¦è¿™æ ·è®¾è®¡ï¼Ÿ

**ç­”**ï¼š
- **ç¬¬ä¸€é¡¹ï¼ˆç¡¬æ ‡ç­¾ï¼‰**ï¼šç¡®ä¿ Student èƒ½æ­£ç¡®åˆ†ç±»ï¼ˆä¸èƒ½åªå­¦ Teacherï¼ŒTeacher ä¹Ÿå¯èƒ½é”™ï¼‰
- **ç¬¬äºŒé¡¹ï¼ˆè½¯æ ‡ç­¾ï¼‰**ï¼šè®© Student å­¦ä¹  Teacher çš„"æ€è€ƒæ–¹å¼"ï¼ˆç±»é—´ç›¸ä¼¼æ€§ï¼‰
- **Î± å¹³è¡¡**ï¼šé€šå¸¸ Î±=0.3ï¼Œæ„å‘³ç€ 30% å…³æ³¨æ­£ç¡®ç­”æ¡ˆï¼Œ70% å…³æ³¨ Teacher çš„çŸ¥è¯†

### Q: Temperature çš„æ•°å­¦ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**ç­”**ï¼š
- **æ•°å­¦ä¸Š**ï¼šTemperature æ§åˆ¶ softmax çš„"é™¡å³­ç¨‹åº¦"
- **ç›´è§‚ä¸Š**ï¼šT è¶Šå¤§ï¼Œæ¦‚ç‡åˆ†å¸ƒè¶Šå¹³æ»‘ï¼Œå°æ¦‚ç‡å€¼è¢«æ”¾å¤§
- **æ•ˆæœä¸Š**ï¼šæš´éœ²æ›´å¤š"æš—çŸ¥è¯†"ï¼ˆç±»é—´ç›¸ä¼¼æ€§ï¼‰

### Q: TÂ² çš„æ•°å­¦æ¨å¯¼è¿‡ç¨‹ï¼Ÿ

**ç­”**ï¼š
1. Softmax é™¤ä»¥ T åï¼Œæ¢¯åº¦ä¼šç¼©å°çº¦ $1/T^2$
2. ä¸ºäº†ä¿æŒæ¢¯åº¦é‡çº§ä¸€è‡´ï¼Œéœ€è¦ä¹˜ä»¥ $T^2$ è¡¥å¿
3. è¿™æ ·ä¸åŒ T å€¼ä¸‹çš„è®­ç»ƒç¨³å®šæ€§ç›¸åŒ

### Q: Forward KL çš„æ•°å­¦ä¼˜åŠ¿ï¼Ÿ

**ç­”**ï¼š
- **æ•°å­¦ä¸Š**ï¼š$D_{KL}(P\|Q) = \sum P_i \log \frac{P_i}{Q_i}$
- **æ€§è´¨**ï¼šå½“ $P_i > 0$ ä½† $Q_i \to 0$ æ—¶ï¼ŒæŸå¤± â†’ âˆ
- **æ•ˆæœ**ï¼šè¿«ä½¿ Student å¿…é¡»è¦†ç›– Teacher çš„æ‰€æœ‰éé›¶æ¦‚ç‡
- **é€‚åˆè’¸é¦**ï¼šå› ä¸ºæˆ‘ä»¬æƒ³è¦ Student å­¦ä¹  Teacher çš„å…¨éƒ¨çŸ¥è¯†

---

## 8. å®æˆ˜ç†è§£ï¼šçœ‹ä»£ç å¯¹åº”æ•°å­¦

### 8.1 ä»£ç ç‰‡æ®µï¼ˆdistillation.pyï¼‰

```python
# ç¡¬æ ‡ç­¾æŸå¤±
hard_loss = self.ce_loss(student_logits, labels)  # L_CE

# è½¯æ ‡ç­¾æŸå¤±
student_soft = F.log_softmax(student_logits / self.temperature, dim=1)  # log Q
teacher_soft = F.softmax(teacher_logits / self.temperature, dim=1)      # P
soft_loss = self.kl_loss(student_soft, teacher_soft) * (self.temperature ** 2)  # TÂ² * L_KL

# ç»„åˆæŸå¤±
total_loss = self.alpha * hard_loss + (1 - self.alpha) * soft_loss
```

**å¯¹åº”æ•°å­¦**ï¼š
- `hard_loss` = $L_{CE}$
- `student_soft` = $\log Q_i$ï¼ˆlog softmaxï¼‰
- `teacher_soft` = $P_i$ï¼ˆsoftmaxï¼‰
- `soft_loss` = $T^2 \cdot D_{KL}(P \| Q)$
- `total_loss` = $\alpha L_{CE} + (1-\alpha) T^2 L_{KL}$

---

## 9. è®°å¿†æŠ€å·§

### 9.1 æŸå¤±å‡½æ•°è®°å¿†æ³•

**"30% ç¡¬ï¼Œ70% è½¯ï¼Œæ¸©åº¦å¹³æ–¹æ¥è¡¥å¿"**
- 30% = Î± = 0.3ï¼ˆç¡¬æ ‡ç­¾æƒé‡ï¼‰
- 70% = 1-Î± = 0.7ï¼ˆè½¯æ ‡ç­¾æƒé‡ï¼‰
- æ¸©åº¦å¹³æ–¹ = $T^2$ï¼ˆæ¢¯åº¦è¡¥å¿ï¼‰

### 9.2 KL æ•£åº¦è®°å¿†æ³•

**"Forward KLï¼šTeacher è¯´å•¥ï¼ŒStudent å¿…é¡»å¬"**
- Forward KLï¼š$D_{KL}(P_{teacher} \| Q_{student})$
- Teacher è®¤ä¸ºå¯èƒ½çš„ï¼ŒStudent ä¹Ÿå¿…é¡»è®¤ä¸ºå¯èƒ½
- å¦åˆ™æŸå¤±çˆ†ç‚¸

### 9.3 Temperature è®°å¿†æ³•

**"T è¶Šå¤§ï¼Œåˆ†å¸ƒè¶Šå¹³ï¼Œæš—çŸ¥è¯†è¶Šå¤š"**
- T=1ï¼šå°–é”ï¼Œåƒ one-hot
- T=4~16ï¼šå¹³æ»‘ï¼Œæš´éœ²ç›¸ä¼¼æ€§
- Tâ†’âˆï¼šå‡åŒ€åˆ†å¸ƒ

---

**ç¥ä½ é¢è¯•é¡ºåˆ©ï¼è®°ä½ï¼šç†è§£æ•°å­¦èƒŒåçš„ç›´è§‰æ¯”æ­»è®°å…¬å¼æ›´é‡è¦ï¼** ğŸ“

